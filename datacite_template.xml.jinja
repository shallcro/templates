{% set study = tree.get('study', [{}])[0] %}
{% set series  = tree.get('series', []) %}
{% set dataset = tree.get('dataset', []) %}

<resource xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://datacite.org/schema/kernel-4" xsi:schemaLocation="http://datacite.org/schema/kernel-4 http://schema.datacite.org/meta/kernel-4/metadata.xsd">

	{# DOI #}
	{% if study.doi %}
	    <identifier identifierType="DOI">{{ study.doi[0] | replace("https://doi.org/", "") }}</identifier>
	{% endif %}

	{# Principal Investigators: include affiliation, if relevant #}
    {% if study.creator %}
        <creators>
        {% for creator in study.creator %}   
        	<creator>                 
            {% if creator.type == 'foaf:Person' %}
            	<creatorName nameType="Personal">{{ creator.name }}</creatorName>
                {% if creator.affiliation %}
                    <affiliation>{{ creator.affiliation }}</affiliation>
                {% endif %}
            {% else %}
                <creatorName nameType="Organizational">{{ creator.name }}</creatorName>
            {% endif %}
            </creator>
        {% endfor %}
        </creators>
    {% endif %}

    {# Title of study #}
    <titles>
    {% if study.title %}
        <title xml:lang="en">{{ study.title[0] | trim | replace('"', "&quot;") | replace("'", "&apos;") | escape }}</title>
    {% endif %}

    {# Alternate Title #}
    {% if study.altTitle %}
        {% for altTitle in study.altTitle %}
            <title titleType="AlternativeTitle" xml:lang="en">{{ altTitle | trim | replace('"', "&quot;") | replace("'", "&apos;") | escape }}</title>
        {% endfor %}
    {% endif %}
    </titles>

    {# Distributors #}
    {% if study.distributor %}
        <publisher>{{ study.distributor[0] }}</publisher>

    {# Version Date #}
    <publicationYear>{{ (study.issued[0] if study.version[0] == 'V1' else study.modified[0]) | from_iso_date | format_date('%Y-%m-%d') }}</publicationYear>

   	{# Data Type #}
    {% if study.kindOfData %}
    	<resourceType resourceTypeGeneral="Dataset">{{ study.kindOfData | join('\n') | trim }}</resourceType>

	{# Subject Terms #}
    {% if study.keyword %}
        <subjects>
        {% for keyword in study.keyword %}
            <subject subjectScheme="ICPSR thesaurus" xml:lang="en">{{ keyword | trim | replace('"', "&quot;") | replace("'", "&apos;") | escape }}</subject>
        {% endfor %}
        </subjects>
    {% endif %}

    {# Time Period #}
    {% if study.timePeriod %}
    	<dates>
    	{% for period in study.timePeriod %}
    		{% if period.startDate and period.endDate %}
    			{% set dateEntry = period.startDate ~ "/" ~ period.endDate %}

			{% elif period.startDate and period.endDate is not defined %}
				{% set dateEntry = period.startDate %}
			{% elif period.endDate and period.startDate is not defined %}
				{% set dateEntry = period.endDate %}
			{% endif %}

			<date dateType="Valid">{{ dateEntry }}</date>
		{% endfor %}
	{% endif %}


    <alternateIdentifiers>
    <alternateIdentifier alternateIdentifierType='ICPSR Study Number'>5</alternateIdentifier>